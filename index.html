<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Sekolah Terpadu - SMP Nurul Hadina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* ============================================
       SECTION 1: GLOBAL STYLES & RESET
       ============================================ */
        [x-cloak] {
            display: none !important;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #F1F5F9;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* ============================================
       SECTION 2: NAVIGATION STYLES
       ============================================ */
        .nav-btn {
            @apply flex-1 py-3 text-sm font-bold text-center transition-all rounded-t-lg border-b-4 border-transparent;
        }

        .nav-btn.active {
            @apply bg-white text-blue-700 border-blue-600 shadow-sm;
        }

        .nav-btn.inactive {
            @apply bg-slate-200 text-slate-500 hover:bg-slate-300;
        }

        /* ============================================
       SECTION 3: CARD & LIST COMPONENTS
       ============================================ */
        .card-item {
            @apply bg-white p-4 rounded-xl shadow-sm border border-slate-100 cursor-pointer hover:shadow-md active:bg-blue-50 transition-all;
        }

        .badge {
            @apply inline-block px-2 py-0.5 rounded-full text-xs font-bold;
        }

        .badge-success {
            @apply bg-green-100 text-green-700;
        }

        .badge-warning {
            @apply bg-yellow-100 text-yellow-700;
        }

        .badge-danger {
            @apply bg-red-100 text-red-700;
        }

        /* ============================================
       SECTION 4: MODAL & OVERLAY
       ============================================ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        /* ============================================
       SECTION 5: FORM ELEMENTS
       ============================================ */
        .input-field {
            @apply w-full p-2.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white transition-all;
        }

        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-bold text-sm shadow-md active:scale-95 transition-all;
        }

        .btn-success {
            @apply bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-lg font-bold text-sm shadow-md active:scale-95 transition-all;
        }

        .btn-danger {
            @apply bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-lg font-bold text-sm shadow-md active:scale-95 transition-all;
        }

        /* ============================================
       SECTION 6: PREVIEW A4 LAYOUT
       ============================================ */
        .preview-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
            background: #334155;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            flex-shrink: 0;
            z-index: 110;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(4px);
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #475569;
        }

        .scroll-area {
            flex-grow: 1;
            overflow: auto;
            display: grid;
            place-items: center;
            padding: 50px;
            touch-action: pan-x pan-y;
            cursor: grab;
        }

        .scroll-area:active {
            cursor: grabbing;
        }

        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            flex-shrink: 0;
            background: white;
            padding: 15mm;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            transform-origin: center top;
            transition: transform 0.1s ease-out;
            font-family: 'Times New Roman', serif;
            color: black;
            line-height: 1.15;
        }

        /* ============================================
       SECTION 7: REPORT TABLE STYLES
       ============================================ */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid black;
            font-size: 11px;
            margin-top: 5px;
        }

        .report-table th,
        .report-table td {
            border: 1px solid black;
            padding: 4px;
            vertical-align: middle;
        }

        .report-table th {
            background-color: #f3f4f6;
            text-align: center;
            font-weight: bold;
        }

        .col-nama {
            max-width: 180px;
            word-wrap: break-word;
            white-space: normal;
        }

        /* Info Header Layout */
        .info-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-top: 2px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .left-info td,
        .right-info td {
            padding-bottom: 2px;
            vertical-align: top;
        }

        .left-label {
            width: 60px;
            font-weight: bold;
        }

        .left-sep {
            width: 15px;
            text-align: center;
        }

        .right-info table {
            float: right;
        }

        .right-info td {
            text-align: right;
        }

        .right-label {
            font-weight: bold;
            padding-left: 15px;
        }

        .right-sep {
            width: 15px;
            text-align: center;
        }

        /* ============================================
       SECTION 8: PROGRESS BAR
       ============================================ */
        .progress-container {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            border-radius: 9999px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* ============================================
       SECTION 9: PRINT STYLES
       ============================================ */
        @media print {
            body * {
                visibility: hidden;
            }

            .preview-wrapper {
                position: static;
                display: block;
                background: white;
            }

            .toolbar,
            .scroll-area {
                display: none;
            }

            #printArea,
            #printArea * {
                visibility: visible;
            }

            #printArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                transform: none !important;
                box-shadow: none;
            }

            @page {
                size: A4;
                margin: 15mm;
            }
        }

        /* ============================================
       SECTION 10: UTILITY CLASSES
       ============================================ */
        .text-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body class="pb-24" x-data="appSystem()" x-init="init()">

    <!-- ============================================
       HEADER & NAVIGATION
       ============================================ -->
    <header class="bg-gradient-to-r from-blue-900 to-blue-700 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-lg font-bold leading-none">Sistem Sekolah Terpadu v.1</h1>
                    <p class="text-[10px] text-blue-200 opacity-90">Yayasan Perguruan Islam  Nurul Hadina</p><p class="text-[10px] text-blue-200 opacity-90">Presented by : Fauzan Reza, S.T</p>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Status Sync Indicator -->
                    <div x-show="syncStatus !== 'idle'" class="flex items-center gap-1 text-xs">
                        <div class="w-2 h-2 rounded-full animate-pulse"
                            :class="syncStatus === 'syncing' ? 'bg-yellow-400' : 'bg-green-400'"></div>
                        <span x-text="syncStatus === 'syncing' ? 'Sync...' : 'Online'"></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="bg-slate-200 pt-2 sticky top-[72px] z-30 shadow-md">
        <div class="max-w-4xl mx-auto px-2 flex gap-1">
            <button @click="currentTab='nilai'" :class="currentTab=='nilai' ? 'active nav-btn' : 'inactive nav-btn'">
                üìù Input Nilai
            </button>
            <button @click="currentTab='master'" :class="currentTab=='master' ? 'active nav-btn' : 'inactive nav-btn'">
                üè´ Master Data
            </button>
            <button @click="currentTab='settings'"
                :class="currentTab=='settings' ? 'active nav-btn' : 'inactive nav-btn'">
                ‚öôÔ∏è Pengaturan
            </button>
        </div>
    </div>

    <!-- ============================================
       MAIN CONTENT AREA
       ============================================ -->
    <main class="max-w-4xl mx-auto p-4 min-h-screen">

        <!-- ============================================
         TAB 1: INPUT NILAI (GURU MODE)
         ============================================ -->
        <div x-show="currentTab === 'nilai'" x-transition.opacity class="space-y-6">

            <!-- Filter Section -->
            <div
                class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100 space-y-3 sticky top-[120px] z-20 shadow-sm">
                <h3 class="text-xs font-bold text-blue-800 uppercase tracking-wide mb-2">Filter Laporan Nilai</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-600 uppercase block mb-1">Guru</label>
                        <select x-model="filter.guru_id" @change="updateMapelOptions" class="input-field">
                            <option value="">-- Pilih Guru --</option>
                            <template x-for="g in db.guru" :key="g.id">
                                <option :value="g.id" x-text="g.nama"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-600 uppercase block mb-1">Mata Pelajaran</label>
                        <select x-model="filter.mapel" class="input-field" :disabled="!filter.guru_id">
                            <option value="">-- Pilih Mapel --</option>
                            <template x-for="m in mapelOptions" :key="m">
                                <option :value="m" x-text="m"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-600 uppercase block mb-1">Kelas</label>
                        <select x-model="filter.kelas_id" @change="loadNilaiSiswa" class="input-field">
                            <option value="">-- Pilih Kelas --</option>
                            <template x-for="k in db.kelas" :key="k.id">
                                <option :value="k.id" x-text="`${k.tingkat} ${k.kelas} - ${k.nama_kelas}`"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-600 uppercase block mb-1">Bulan</label>
                        <select x-model="filter.bulan" @change="loadNilaiSiswa" class="input-field">
                            <option>Januari</option>
                            <option>Februari</option>
                            <option>Maret</option>
                            <option>April</option>
                            <option>Mei</option>
                            <option>Juni</option>
                            <option>Juli</option>
                            <option>Agustus</option>
                            <option>September</option>
                            <option>Oktober</option>
                            <option>November</option>
                            <option>Desember</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- List Siswa -->
            <div x-show="isFilterComplete" class="space-y-3">
                <div class="flex flex-wrap justify-between items-center gap-2 px-1">
                    <div class="text-xs text-slate-500">
                        Total Siswa: <span class="font-bold text-blue-600" x-text="nilaiList.length"></span>
                    </div>
                    <div class="flex gap-2">
                        <button @click="openPreview"
                            class="bg-indigo-600 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-md hover:bg-indigo-700 transition flex items-center gap-1">
                            <span>üëÅÔ∏è</span> Review A4
                        </button>
                        <button @click="exportExcel"
                            class="bg-green-600 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-md hover:bg-green-700 transition flex items-center gap-1">
                            <span>üìä</span> Excel
                        </button>
                    </div>
                </div>

                <!-- Siswa Cards -->
                <template x-for="(s, idx) in nilaiList" :key="s.siswa_id">
                    <div @click="openInputModal(s)" class="card-item">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-100 to-indigo-100 flex items-center justify-center text-sm font-bold text-blue-700"
                                    x-text="idx+1"></div>
                                <div class="flex-1">
                                    <div class="font-bold text-sm text-slate-800" x-text="s.nama_siswa"></div>
                                    <div class="text-[10px] text-slate-400 mt-0.5">Tap untuk input nilai</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold"
                                    :class="hitungNilaiAkhir(s) > 0 ? 'text-emerald-600' : 'text-slate-300'">
                                    <span x-text="hitungNilaiAkhir(s) > 0 ? hitungNilaiAkhir(s) : '-'"></span>
                                </div>
                                <div class="text-[9px] text-slate-400 uppercase tracking-wide">Nilai Akhir</div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Empty State -->
            <div x-show="!isFilterComplete"
                class="text-center py-16 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50">
                <div class="text-6xl mb-4 opacity-20">üìö</div>
                <h3 class="text-sm font-bold text-slate-600 mb-1">Silakan Lengkapi Filter</h3>
                <p class="text-xs text-slate-400">Pilih Guru, Mapel, Kelas, dan Bulan untuk mulai input nilai</p>
            </div>
        </div>

        <!-- ============================================
         TAB 2: MASTER DATA (ADMIN MODE)
         ============================================ -->
        <div x-show="currentTab === 'master'" x-transition.opacity class="space-y-6">

            <!-- Sub Navigation -->
            <div class="flex gap-2 overflow-x-auto pb-2">
                <button @click="masterSubTab='guru'"
                    :class="masterSubTab=='guru' ? 'bg-blue-600 text-white' : 'bg-white text-slate-600 border border-slate-200'"
                    class="px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-all shadow-sm">
                    üë®‚Äçüè´ Guru
                </button>
                <button @click="masterSubTab='kelas'"
                    :class="masterSubTab=='kelas' ? 'bg-blue-600 text-white' : 'bg-white text-slate-600 border border-slate-200'"
                    class="px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-all shadow-sm">
                    üéì Kelas
                </button>
                <button @click="masterSubTab='siswa'"
                    :class="masterSubTab=='siswa' ? 'bg-blue-600 text-white' : 'bg-white text-slate-600 border border-slate-200'"
                    class="px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-all shadow-sm">
                    üë¶ Siswa
                </button>
            </div>

            <!-- Guru Section -->
            <div x-show="masterSubTab === 'guru'" class="space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-slate-800">Data Guru</h3>
                    <button @click="openGuruForm()" class="btn-primary text-xs">+ Tambah Guru</button>
                </div>
                <template x-for="g in db.guru" :key="g.id">
                    <div class="card-item">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold text-slate-800" x-text="g.nama"></h4>
                                <p class="text-xs text-slate-500 mt-1">Mengajar: <span
                                        x-text="g.mapel.join(', ')"></span></p>
                            </div>
                            <div class="flex gap-2">
                                <button @click="openGuruForm(g)"
                                    class="text-blue-600 text-xs px-2 py-1 hover:bg-blue-50 rounded">Edit</button>
                                <button @click="deleteGuru(g.id)"
                                    class="text-red-600 text-xs px-2 py-1 hover:bg-red-50 rounded">Hapus</button>
                            </div>
                        </div>
                    </div>
                </template>
                <div x-show="db.guru.length === 0" class="text-center py-8 text-slate-400 text-sm">
                    Belum ada data guru. Klik "Tambah Guru" untuk memulai.
                </div>
            </div>

            <!-- Kelas Section -->
            <div x-show="masterSubTab === 'kelas'" class="space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-slate-800">Data Kelas</h3>
                    <button @click="openKelasForm()" class="btn-primary text-xs">+ Tambah Kelas</button>
                </div>
                <template x-for="k in db.kelas" :key="k.id">
                    <div class="card-item">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-slate-800"
                                    x-text="`${k.tingkat} ${k.kelas} - ${k.nama_kelas}`"></h4>
                                <p class="text-xs text-slate-500 mt-1">Wali Kelas: <span
                                        x-text="k.wali_kelas || '-'"></span></p>
                            </div>
                            <div class="flex gap-2">
                                <button @click="openKelasForm(k)"
                                    class="text-blue-600 text-xs px-2 py-1 hover:bg-blue-50 rounded">Edit</button>
                                <button @click="deleteKelas(k.id)"
                                    class="text-red-600 text-xs px-2 py-1 hover:bg-red-50 rounded">Hapus</button>
                            </div>
                        </div>
                    </div>
                </template>
                <div x-show="db.kelas.length === 0" class="text-center py-8 text-slate-400 text-sm">
                    Belum ada data kelas. Klik "Tambah Kelas" untuk memulai.
                </div>
            </div>

            <!-- Siswa Section -->
            <div x-show="masterSubTab === 'siswa'" class="space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-slate-800">Data Siswa</h3>
                    <button @click="openSiswaForm()" class="btn-primary text-xs">+ Tambah Siswa</button>
                </div>

                <!-- Filter Kelas untuk Siswa -->
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <label class="text-xs font-bold text-slate-600 block mb-2">Filter berdasarkan Kelas:</label>
                    <select x-model="siswaFilterKelas" class="input-field">
                        <option value="">Semua Kelas</option>
                        <template x-for="k in db.kelas" :key="k.id">
                            <option :value="k.id" x-text="`${k.tingkat} ${k.kelas} - ${k.nama_kelas}`"></option>
                        </template>
                    </select>
                </div>

                <template x-for="s in filteredSiswa" :key="s.id">
                    <div class="card-item">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <h4 class="font-bold text-slate-800" x-text="s.nama"></h4>
                                <p class="text-xs text-slate-500 mt-1">
                                    Kelas: <span x-text="getKelasName(s.kelas_id)"></span>
                                    <template x-if="s.no_hp">
                                        <span class="ml-2">üì± <span x-text="s.no_hp"></span></span>
                                    </template>
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button @click="openSiswaForm(s)"
                                    class="text-blue-600 text-xs px-2 py-1 hover:bg-blue-50 rounded">Edit</button>
                                <button @click="deleteSiswa(s.id)"
                                    class="text-red-600 text-xs px-2 py-1 hover:bg-red-50 rounded">Hapus</button>
                            </div>
                        </div>
                    </div>
                </template>
                <div x-show="filteredSiswa.length === 0" class="text-center py-8 text-slate-400 text-sm">
                    Belum ada data siswa. Klik "Tambah Siswa" untuk memulai.
                </div>
            </div>
        </div>

        <!-- ============================================
         TAB 3: PENGATURAN (SETTINGS)
         ============================================ -->
        <div x-show="currentTab === 'settings'" x-transition.opacity class="space-y-6">

            <h2 class="text-xl font-bold text-slate-800">Pengaturan Sistem</h2>

            <!-- Google Drive Sync -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                    <span class="text-2xl">‚òÅÔ∏è</span> Sinkronisasi Google Drive
                </h3>
                <p class="text-xs text-slate-600 mb-4">
                    Masukkan link file JSON Master Data dari Google Drive untuk menarik data Guru, Kelas, dan Siswa
                    secara otomatis.
                </p>

                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-slate-600 block mb-2">URL Google Drive (JSON):</label>
                        <input type="url" x-model="config.gdrive_url"
                            placeholder="https://drive.google.com/uc?export=download&id=..."
                            class="input-field font-mono text-xs">
                    </div>

                    <div class="flex items-center gap-3">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" x-model="config.auto_sync" class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                            </div>
                            <span class="ml-3 text-sm font-medium text-slate-700">Auto Sync saat buka aplikasi</span>
                        </label>
                    </div>

                    <button @click="manualSync" class="btn-primary w-full" :disabled="syncing">
                        <span x-show="!syncing">Tarik Data Sekarang</span>
                        <span x-show="syncing">Menarik Data...</span>
                    </button>

                    <!-- Progress Bar -->
                    <div x-show="syncing" class="space-y-2">
                        <div class="progress-container">
                            <div class="progress-bar" :style="`width: ${syncProgress}%`"></div>
                        </div>
                        <p class="text-xs text-center text-slate-600" x-text="`${syncProgress}% - ${syncMessage}`"></p>
                    </div>

                    <div x-show="syncResult" class="p-3 rounded-lg text-sm"
                        :class="syncResult === 'success' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'">
                        <span x-text="syncResultMessage"></span>
                    </div>
                </div>
            </div>

            <!-- Backup & Restore -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                    <span class="text-2xl">üíæ</span> Backup & Restore Database
                </h3>
                <p class="text-xs text-slate-600 mb-4">
                    Simpan semua data (Master Data + Nilai) ke file JSON atau restore dari file backup sebelumnya.
                </p>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <button @click="backupDatabase" class="btn-success w-full">
                        üì• Backup Database
                    </button>
                    <button @click="$refs.restoreFile.click()" class="btn-primary w-full">
                        üì§ Restore Database
                    </button>
                    <input type="file" x-ref="restoreFile" @change="restoreDatabase($event)" accept=".json"
                        class="hidden">
                </div>
            </div>

            <!-- Reset Data -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-red-200">
                <h3 class="font-bold text-red-700 mb-3 flex items-center gap-2">
                    <span class="text-2xl">‚ö†Ô∏è</span> Reset Semua Data
                </h3>
                <p class="text-xs text-slate-600 mb-4">
                    <strong>PERINGATAN:</strong> Aksi ini akan menghapus semua data Master dan Nilai yang tersimpan di
                    perangkat ini. Pastikan Anda sudah backup terlebih dahulu!
                </p>
                <button @click="resetAllData" class="btn-danger w-full">
                    üóëÔ∏è Reset Semua Data
                </button>
            </div>

            <!-- App Info -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-xl border border-blue-100">
                <h3 class="font-bold text-blue-800 mb-2">Informasi Aplikasi</h3>
                <div class="text-xs text-slate-600 space-y-1">
                    <p><strong>Versi:</strong> 1.0.0</p>
                    <p><strong>Database:</strong> <span
                            x-text="db.guru.length + db.kelas.length + db.siswa.length"></span> records (Master) + <span
                            x-text="db.nilai.length"></span> records (Nilai)</p>
                    <p><strong>Storage:</strong> LocalStorage Browser</p>
                </div>
            </div>
        </div>

    </main>

    <!-- ============================================
       MODAL: INPUT NILAI
       ============================================ -->
    <div x-show="showInputModal" class="modal-overlay" x-cloak>
        <div class="modal-content" @click.away="closeInputModal">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-bold text-slate-800" x-text="activeSiswa.nama_siswa"></h3>
                    <p class="text-xs text-slate-500">Input Nilai Siswa</p>
                </div>
                <button @click="closeInputModal"
                    class="text-slate-400 hover:text-red-500 text-2xl leading-none">&times;</button>
            </div>

            <div class="p-5 space-y-4">
                <!-- Formatif -->
                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 p-4 rounded-xl border border-indigo-100">
                    <label class="block text-xs font-bold text-indigo-800 uppercase mb-2">Nilai Formatif (X)</label>
                    <input type="number" x-model="activeSiswa.formatif"
                        class="w-full text-3xl font-bold text-center p-3 border-2 border-indigo-200 rounded-lg bg-white outline-none focus:border-indigo-500 text-indigo-700"
                        placeholder="0" min="0" max="100">
                </div>

                <!-- Nilai Mingguan -->
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase mb-2">Tugas & Pekerjaan Rumah
                        (Mingguan)</label>
                    <div class="grid grid-cols-4 gap-2">
                        <div class="text-center">
                            <label class="text-[10px] text-slate-500 block mb-1">Minggu 1</label>
                            <input type="number" x-model="activeSiswa.m1"
                                class="w-full text-center p-2 border rounded-lg bg-slate-50 font-bold focus:ring-2 focus:ring-blue-500 outline-none"
                                min="0" max="100">
                        </div>
                        <div class="text-center">
                            <label class="text-[10px] text-slate-500 block mb-1">Minggu 2</label>
                            <input type="number" x-model="activeSiswa.m2"
                                class="w-full text-center p-2 border rounded-lg bg-slate-50 font-bold focus:ring-2 focus:ring-blue-500 outline-none"
                                min="0" max="100">
                        </div>
                        <div class="text-center">
                            <label class="text-[10px] text-slate-500 block mb-1">Minggu 3</label>
                            <input type="number" x-model="activeSiswa.m3"
                                class="w-full text-center p-2 border rounded-lg bg-slate-50 font-bold focus:ring-2 focus:ring-blue-500 outline-none"
                                min="0" max="100">
                        </div>
                        <div class="text-center">
                            <label class="text-[10px] text-slate-500 block mb-1">Minggu 4</label>
                            <input type="number" x-model="activeSiswa.m4"
                                class="w-full text-center p-2 border rounded-lg bg-slate-50 font-bold focus:ring-2 focus:ring-blue-500 outline-none"
                                min="0" max="100">
                        </div>
                    </div>
                </div>

                <!-- Preview Nilai -->
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div>
                            <div class="text-xs text-slate-500 mb-1">Rata-rata Tugas (Y)</div>
                            <div class="text-2xl font-bold text-blue-600" x-text="hitungRataMingguan(activeSiswa)">
                            </div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-500 mb-1">Nilai Akhir</div>
                            <div class="text-2xl font-bold text-green-600" x-text="hitungNilaiAkhir(activeSiswa)"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-5 border-t border-slate-200">
                <button @click="saveAndCloseInput" class="btn-primary w-full py-3">
                    üíæ Simpan Nilai
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
       MODAL: FORM GURU
       ============================================ -->
    <div x-show="showGuruModal" class="modal-overlay" x-cloak>
        <div class="modal-content" @click.away="closeGuruModal">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800" x-text="formGuru.id ? 'Edit Guru' : 'Tambah Guru Baru'">
                </h3>
                <button @click="closeGuruModal" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button>
            </div>

            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-2">Nama Lengkap Guru</label>
                    <input type="text" x-model="formGuru.nama" class="input-field"
                        placeholder="Contoh: Ahmad Dahlan, S.Pd">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-2">Mata Pelajaran yang Diajar (Pisahkan
                        dengan koma)</label>
                    <input type="text" x-model="formGuru.mapel_str" class="input-field"
                        placeholder="Matematika, Fisika">
                    <p class="text-[10px] text-slate-400 mt-1">Contoh: Matematika, Bahasa Indonesia</p>
                </div>
            </div>

            <div class="p-5 border-t border-slate-200 flex gap-3">
                <button @click="closeGuruModal"
                    class="flex-1 py-2.5 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50">
                    Batal
                </button>
                <button @click="saveGuru" class="flex-1 btn-primary">
                    Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
       MODAL: FORM KELAS
       ============================================ -->
    <div x-show="showKelasModal" class="modal-overlay" x-cloak>
        <div class="modal-content" @click.away="closeKelasModal">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800" x-text="formKelas.id ? 'Edit Kelas' : 'Tambah Kelas Baru'">
                </h3>
                <button @click="closeKelasModal" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button>
            </div>

            <div class="p-5 space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Tingkat</label>
                        <select x-model="formKelas.tingkat" class="input-field">
                            <option>SMP</option>
                            <option>MTs</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Kelas</label>
                        <select x-model="formKelas.kelas" class="input-field">
                            <option>VII</option>
                            <option>VIII</option>
                            <option>IX</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-2">Nama Kelas</label>
                    <input type="text" x-model="formKelas.nama_kelas" class="input-field"
                        placeholder="Contoh: Unggulan, IPA 1">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-2">Wali Kelas (Opsional)</label>
                    <input type="text" x-model="formKelas.wali_kelas" class="input-field" placeholder="Nama Wali Kelas">
                </div>
            </div>

            <div class="p-5 border-t border-slate-200 flex gap-3">
                <button @click="closeKelasModal"
                    class="flex-1 py-2.5 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50">
                    Batal
                </button>
                <button @click="saveKelas" class="flex-1 btn-primary">
                    Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
       MODAL: FORM SISWA
       ============================================ -->
    <div x-show="showSiswaModal" class="modal-overlay" x-cloak>
        <div class="modal-content" @click.away="closeSiswaModal">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800" x-text="formSiswa.id ? 'Edit Siswa' : 'Tambah Siswa Baru'">
                </h3>
                <button @click="closeSiswaModal" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button>
            </div>

            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-2">Nama Lengkap Siswa</label>
                    <input type="text" x-model="formSiswa.nama" class="input-field" placeholder="Nama siswa">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-2">Kelas</label>
                    <select x-model="formSiswa.kelas_id" class="input-field">
                        <option value="">-- Pilih Kelas --</option>
                        <template x-for="k in db.kelas" :key="k.id">
                            <option :value="k.id" x-text="`${k.tingkat} ${k.kelas} - ${k.nama_kelas}`"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-2">No HP Siswa/Wali (Opsional)</label>
                    <input type="tel" x-model="formSiswa.no_hp" class="input-field" placeholder="08123456789">
                    <p class="text-[10px] text-slate-400 mt-1">Untuk fitur kirim laporan via WhatsApp</p>
                </div>
            </div>

            <div class="p-5 border-t border-slate-200 flex gap-3">
                <button @click="closeSiswaModal"
                    class="flex-1 py-2.5 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50">
                    Batal
                </button>
                <button @click="saveSiswa" class="flex-1 btn-primary">
                    Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
       PREVIEW A4 (FULL SCREEN)
       ============================================ -->
    <div x-show="showPreview" class="preview-wrapper" x-cloak>
        <div class="toolbar text-white">
            <button @click="showPreview=false"
                class="bg-red-600 hover:bg-red-500 px-3 py-1.5 rounded-lg text-xs font-bold transition">
                ‚úï Tutup
            </button>
            <div class="flex items-center gap-2 bg-slate-700 px-3 py-1 rounded-lg">
                <button @click="zoomLevel = Math.max(0.3, zoomLevel - 0.1)"
                    class="text-lg font-bold px-2 hover:text-blue-300">Ôºç</button>
                <span class="text-xs font-mono w-12 text-center" x-text="Math.round(zoomLevel*100)+'%'"></span>
                <button @click="zoomLevel = Math.min(3.0, zoomLevel + 0.1)"
                    class="text-lg font-bold px-2 hover:text-blue-300">Ôºã</button>
            </div>
            <button @click="printPDF"
                class="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded-lg text-xs font-bold transition">
                üñ®Ô∏è Print / PDF
            </button>
        </div>

        <div class="scroll-area">
            <div id="printArea" class="a4-paper" :style="`transform: scale(${zoomLevel})`">

                <!-- Header Laporan -->
                <div class="text-center font-serif mb-0">
                    <h2 class="text-lg font-bold uppercase m-0">LAPORAN NILAI BULANAN</h2>
                    <h1 class="text-2xl font-extrabold uppercase m-0">SMP SWASTA NURUL HADINA</h1>
                    <p class="text-sm m-0">Tahun Ajaran 2025/2026</p>
                    <div class="w-full border-b-2 border-black mt-2"></div>
                    <div class="w-full border-b border-black mt-0.5 mb-1"></div>
                </div>

                <!-- Info Laporan -->
                <div class="info-container font-serif">
                    <div class="left-info">
                        <table>
                            <tr>
                                <td class="left-label">Kelas</td>
                                <td class="left-sep">:</td>
                                <td x-text="previewInfo.kelas"></td>
                            </tr>
                            <tr>
                                <td class="left-label">Bulan</td>
                                <td class="left-sep">:</td>
                                <td x-text="previewInfo.bulan"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="right-info">
                        <table>
                            <tr>
                                <td class="right-label">Mata Pelajaran</td>
                                <td class="right-sep">:</td>
                                <td x-text="previewInfo.mapel"></td>
                            </tr>
                            <tr>
                                <td class="right-label">Guru Mapel</td>
                                <td class="right-sep">:</td>
                                <td x-text="previewInfo.guru"></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Tabel Nilai -->
                <table class="report-table">
                    <thead>
                        <tr>
                            <th rowspan="2" style="width: 30px;">No</th>
                            <th rowspan="2" style="width: 200px;">Nama Siswa</th>
                            <th rowspan="2" style="width: 60px;">Formatif<br>(X)</th>
                            <th colspan="4">Tugas dan Pekerjaan Rumah</th>
                            <th rowspan="2" style="width: 65px;">Rata-rata<br>Tugas & PR<br>(Y)</th>
                            <th rowspan="2" style="width: 65px; background-color: #e5e7eb;">Nilai Akhir<br>(X + Y) / 2
                            </th>
                        </tr>
                        <tr>
                            <th style="width: 40px;">Mg 1</th>
                            <th style="width: 40px;">Mg 2</th>
                            <th style="width: 40px;">Mg 3</th>
                            <th style="width: 40px;">Mg 4</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(row, i) in nilaiList" :key="row.siswa_id">
                            <tr>
                                <td class="text-center" x-text="i+1"></td>
                                <td class="col-nama" x-text="row.nama_siswa"></td>
                                <td class="text-center" x-text="row.formatif || '-'"></td>
                                <td class="text-center" x-text="row.m1 || '-'"></td>
                                <td class="text-center" x-text="row.m2 || '-'"></td>
                                <td class="text-center" x-text="row.m3 || '-'"></td>
                                <td class="text-center" x-text="row.m4 || '-'"></td>
                                <td class="text-center font-bold" x-text="hitungRataMingguan(row)"></td>
                                <td class="text-center font-bold" style="background-color: #f9fafb;"
                                    x-text="hitungNilaiAkhir(row)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>

                <!-- Tanda Tangan -->
                <div class="mt-10 flex justify-between px-8 font-serif text-sm">
                    <div class="text-center">
                        <p>Mengetahui,</p>
                        <p class="mb-16">Kepala Sekolah</p>
                        <p class="font-bold border-b border-black inline-block min-w-[150px]">(
                            ................................. )</p>
                    </div>
                    <div class="text-center">
                        <p class="mb-16">Guru Mata Pelajaran,</p>
                        <p class="font-bold border-b border-black inline-block min-w-[150px]" x-text="previewInfo.guru">
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
       JAVASCRIPT LOGIC (ALPINE.JS)
       ============================================ -->
    <script>
        function appSystem() {
            return {
                // STATE
                currentTab: 'nilai',
                masterSubTab: 'guru',

                // DATABASE
                db: {
                    guru: [],
                    kelas: [],
                    siswa: [],
                    nilai: []
                },

                // CONFIG
                config: {
                    gdrive_url: 'https://drive.google.com/uc?export=download&id=1--Imrir9HdAY62XjdFu_gMB0R_GJQJE2',
                    auto_sync: false
                },

                // FILTER NILAI
                filter: {
                    guru_id: '',
                    mapel: '',
                    kelas_id: '',
                    bulan: 'Oktober'
                },
                mapelOptions: [],
                nilaiList: [],

                // MODALS
                showInputModal: false,
                showGuruModal: false,
                showKelasModal: false,
                showSiswaModal: false,
                showPreview: false,

                // FORMS
                activeSiswa: {},
                formGuru: {},
                formKelas: {},
                formSiswa: {},

                // PREVIEW
                previewInfo: {},
                zoomLevel: 0.6,

                // SISWA FILTER
                siswaFilterKelas: '',

                // SYNC
                syncStatus: 'idle',
                syncing: false,
                syncProgress: 0,
                syncMessage: '',
                syncResult: null,
                syncResultMessage: '',

                // ===================================
                // INIT
                // ===================================
                init() {
                    this.loadFromStorage();

                    // Auto Sync jika enabled
                    if (this.config.auto_sync && this.config.gdrive_url) {
                        setTimeout(() => {
                            this.manualSync();
                        }, 1000);
                    }
                },

                // ===================================
                // COMPUTED PROPERTIES
                // ===================================
                get isFilterComplete() {
                    return this.filter.guru_id && this.filter.mapel && this.filter.kelas_id && this.filter.bulan;
                },

                get filteredSiswa() {
                    if (!this.siswaFilterKelas) return this.db.siswa;
                    return this.db.siswa.filter(s => s.kelas_id == this.siswaFilterKelas);
                },

                // ===================================
                // INPUT NILAI LOGIC
                // ===================================
                updateMapelOptions() {
                    this.filter.mapel = '';
                    const guru = this.db.guru.find(g => g.id == this.filter.guru_id);
                    this.mapelOptions = guru ? guru.mapel : [];
                },

                loadNilaiSiswa() {
                    if (!this.isFilterComplete) return;

                    const siswaKelas = this.db.siswa.filter(s => s.kelas_id == this.filter.kelas_id);
                    this.nilaiList = siswaKelas.map(s => {
                        const existing = this.db.nilai.find(n =>
                            n.siswa_id == s.id &&
                            n.guru_id == this.filter.guru_id &&
                            n.mapel == this.filter.mapel &&
                            n.bulan == this.filter.bulan
                        );
                        return {
                            siswa_id: s.id,
                            nama_siswa: s.nama,
                            formatif: existing ? existing.formatif : '',
                            m1: existing ? existing.m1 : '',
                            m2: existing ? existing.m2 : '',
                            m3: existing ? existing.m3 : '',
                            m4: existing ? existing.m4 : ''
                        };
                    }).sort((a, b) => a.nama_siswa.localeCompare(b.nama_siswa));
                },

                openInputModal(siswa) {
                    this.activeSiswa = JSON.parse(JSON.stringify(siswa));
                    this.showInputModal = true;
                },

                closeInputModal() {
                    this.showInputModal = false;
                },

                saveAndCloseInput() {
                    const idx = this.nilaiList.findIndex(s => s.siswa_id === this.activeSiswa.siswa_id);
                    if (idx !== -1) {
                        this.nilaiList[idx] = this.activeSiswa;
                    }
                    this.saveNilaiToDB();
                    this.showInputModal = false;
                },

                hitungRataMingguan(row) {
                    const vals = [row.m1, row.m2, row.m3, row.m4]
                        .map(v => parseFloat(v))
                        .filter(v => !isNaN(v) && v !== "");
                    return vals.length ? Math.round(vals.reduce((a, b) => a + b, 0) / vals.length) : 0;
                },

                hitungNilaiAkhir(row) {
                    const formatif = parseFloat(row.formatif) || 0;
                    const rataMingguan = this.hitungRataMingguan(row);
                    return (formatif || rataMingguan) ? Math.round((formatif + rataMingguan) / 2) : 0;
                },

                saveNilaiToDB() {
                    // Hapus nilai lama untuk konteks yang sama
                    this.db.nilai = this.db.nilai.filter(n =>
                        !(n.guru_id == this.filter.guru_id &&
                            n.mapel == this.filter.mapel &&
                            n.kelas_id == this.filter.kelas_id &&
                            n.bulan == this.filter.bulan)
                    );

                    // Tambahkan nilai baru
                    this.nilaiList.forEach(row => {
                        if (row.formatif || row.m1 || row.m2 || row.m3 || row.m4) {
                            this.db.nilai.push({
                                id: Date.now() + Math.random(),
                                siswa_id: row.siswa_id,
                                kelas_id: this.filter.kelas_id,
                                guru_id: this.filter.guru_id,
                                mapel: this.filter.mapel,
                                bulan: this.filter.bulan,
                                formatif: row.formatif,
                                m1: row.m1,
                                m2: row.m2,
                                m3: row.m3,
                                m4: row.m4
                            });
                        }
                    });

                    this.saveToStorage();
                },

                // ===================================
                // MASTER DATA - GURU
                // ===================================
                openGuruForm(guru = null) {
                    if (guru) {
                        this.formGuru = {
                            id: guru.id,
                            nama: guru.nama,
                            mapel_str: guru.mapel.join(', ')
                        };
                    } else {
                        this.formGuru = { nama: '', mapel_str: '' };
                    }
                    this.showGuruModal = true;
                },

                closeGuruModal() {
                    this.showGuruModal = false;
                    this.formGuru = {};
                },

                saveGuru() {
                    if (!this.formGuru.nama || !this.formGuru.mapel_str) {
                        alert('Nama dan Mapel harus diisi!');
                        return;
                    }

                    const mapelArray = this.formGuru.mapel_str.split(',').map(m => m.trim()).filter(m => m);

                    if (this.formGuru.id) {
                        // Edit
                        const idx = this.db.guru.findIndex(g => g.id == this.formGuru.id);
                        if (idx !== -1) {
                            this.db.guru[idx] = {
                                id: this.formGuru.id,
                                nama: this.formGuru.nama,
                                mapel: mapelArray
                            };
                        }
                    } else {
                        // Tambah
                        this.db.guru.push({
                            id: Date.now(),
                            nama: this.formGuru.nama,
                            mapel: mapelArray
                        });
                    }

                    this.saveToStorage();
                    this.closeGuruModal();
                },

                deleteGuru(id) {
                    if (confirm('Yakin hapus data guru ini?')) {
                        this.db.guru = this.db.guru.filter(g => g.id != id);
                        this.saveToStorage();
                    }
                },

                // ===================================
                // MASTER DATA - KELAS
                // ===================================
                openKelasForm(kelas = null) {
                    if (kelas) {
                        this.formKelas = { ...kelas };
                    } else {
                        this.formKelas = { tingkat: 'SMP', kelas: 'VII', nama_kelas: '', wali_kelas: '' };
                    }
                    this.showKelasModal = true;
                },

                closeKelasModal() {
                    this.showKelasModal = false;
                    this.formKelas = {};
                },

                saveKelas() {
                    if (!this.formKelas.nama_kelas) {
                        alert('Nama kelas harus diisi!');
                        return;
                    }

                    if (this.formKelas.id) {
                        // Edit
                        const idx = this.db.kelas.findIndex(k => k.id == this.formKelas.id);
                        if (idx !== -1) {
                            this.db.kelas[idx] = this.formKelas;
                        }
                    } else {
                        // Tambah
                        this.db.kelas.push({
                            id: Date.now(),
                            ...this.formKelas
                        });
                    }

                    this.saveToStorage();
                    this.closeKelasModal();
                },

                deleteKelas(id) {
                    if (confirm('Yakin hapus kelas ini? Siswa di kelas ini tidak akan terhapus.')) {
                        this.db.kelas = this.db.kelas.filter(k => k.id != id);
                        this.saveToStorage();
                    }
                },

                // ===================================
                // MASTER DATA - SISWA
                // ===================================
                openSiswaForm(siswa = null) {
                    if (siswa) {
                        this.formSiswa = { ...siswa };
                    } else {
                        this.formSiswa = { nama: '', kelas_id: '', no_hp: '' };
                    }
                    this.showSiswaModal = true;
                },

                closeSiswaModal() {
                    this.showSiswaModal = false;
                    this.formSiswa = {};
                },

                saveSiswa() {
                    if (!this.formSiswa.nama || !this.formSiswa.kelas_id) {
                        alert('Nama dan Kelas harus diisi!');
                        return;
                    }

                    if (this.formSiswa.id) {
                        // Edit
                        const idx = this.db.siswa.findIndex(s => s.id == this.formSiswa.id);
                        if (idx !== -1) {
                            this.db.siswa[idx] = this.formSiswa;
                        }
                    } else {
                        // Tambah
                        this.db.siswa.push({
                            id: Date.now(),
                            ...this.formSiswa
                        });
                    }

                    this.saveToStorage();
                    this.closeSiswaModal();
                },

                deleteSiswa(id) {
                    if (confirm('Yakin hapus data siswa ini? Nilai siswa ini juga akan terhapus.')) {
                        this.db.siswa = this.db.siswa.filter(s => s.id != id);
                        this.db.nilai = this.db.nilai.filter(n => n.siswa_id != id);
                        this.saveToStorage();
                    }
                },

                getKelasName(kelasId) {
                    const kelas = this.db.kelas.find(k => k.id == kelasId);
                    return kelas ? `${kelas.tingkat} ${kelas.kelas} - ${kelas.nama_kelas}` : '-';
                },

                // ===================================
                // GOOGLE DRIVE SYNC
                // ===================================
                async manualSync() {
                    if (!this.config.gdrive_url) {
                        alert('https://drive.google.com/uc?export=download&id=1--Imrir9HdAY62XjdFu_gMB0R_GJQJE2');
                        return;
                    }

                    this.syncing = true;
                    this.syncStatus = 'syncing';
                    this.syncProgress = 0;
                    this.syncMessage = 'Memulai sinkronisasi...';
                    this.syncResult = null;

                    try {
                        // Progress simulation
                        this.syncProgress = 20;
                        this.syncMessage = 'Menghubungi Google Drive...';

                        // Gunakan Proxy untuk bypass CORS
                        const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(this.config.gdrive_url);
                        const response = await fetch(proxyUrl);


                        if (!response.ok) {
                            throw new Error('Gagal mengambil data dari Google Drive');
                        }

                        this.syncProgress = 50;
                        this.syncMessage = 'Mengunduh data...';

                        const data = await response.json();

                        this.syncProgress = 70;
                        this.syncMessage = 'Memvalidasi data...';

                        // Validasi struktur data
                        if (!data.guru || !data.kelas || !data.siswa) {
                            throw new Error('Format data tidak valid');
                        }

                        this.syncProgress = 90;
                        this.syncMessage = 'Menyimpan data...';

                        // SMART PATCHING: Hanya update Master Data, jangan sentuh Nilai
                        this.db.guru = data.guru;
                        this.db.kelas = data.kelas;
                        this.db.siswa = data.siswa;

                        // Cleanup nilai yatim piatu (siswa yang sudah tidak ada)
                        const validSiswaIds = this.db.siswa.map(s => s.id);
                        this.db.nilai = this.db.nilai.filter(n => validSiswaIds.includes(n.siswa_id));

                        this.saveToStorage();

                        this.syncProgress = 100;
                        this.syncMessage = 'Selesai!';
                        this.syncResult = 'success';
                        this.syncResultMessage = `Berhasil! ${data.guru.length} Guru, ${data.kelas.length} Kelas, ${data.siswa.length} Siswa telah diperbarui.`;
                        this.syncStatus = 'online';

                    } catch (error) {
                        console.error('Sync error:', error);
                        this.syncResult = 'error';
                        this.syncResultMessage = `Gagal: ${error.message}`;
                        this.syncStatus = 'idle';
                    } finally {
                        this.syncing = false;
                        setTimeout(() => {
                            this.syncProgress = 0;
                            this.syncMessage = '';
                        }, 3000);
                    }
                },

                // ===================================
                // BACKUP & RESTORE
                // ===================================
                backupDatabase() {
                    const backupData = {
                        version: '1.0',
                        timestamp: new Date().toISOString(),
                        db: this.db,
                        config: this.config
                    };

                    const json = JSON.stringify(backupData, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Backup_Sekolah_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                },

                restoreDatabase(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);

                            if (!data.db) {
                                throw new Error('Format file backup tidak valid');
                            }

                            if (confirm('Restore database akan menimpa semua data yang ada. Lanjutkan?')) {
                                this.db = data.db;
                                if (data.config) this.config = data.config;
                                this.saveToStorage();
                                alert('Database berhasil di-restore!');
                                location.reload();
                            }
                        } catch (error) {
                            alert('Error: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                },

                resetAllData() {
                    if (confirm('PERINGATAN: Semua data akan dihapus permanen! Lanjutkan?')) {
                        if (confirm('Konfirmasi sekali lagi. Yakin ingin reset?')) {
                            localStorage.clear();
                            location.reload();
                        }
                    }
                },

                // ===================================
                // PREVIEW & EXPORT
                // ===================================
                openPreview() {
                    if (!this.isFilterComplete) return;

                    const guru = this.db.guru.find(g => g.id == this.filter.guru_id);
                    const kelas = this.db.kelas.find(k => k.id == this.filter.kelas_id);

                    this.previewInfo = {
                        guru: guru ? guru.nama : '-',
                        mapel: this.filter.mapel,
                        kelas: kelas ? `${kelas.tingkat} ${kelas.kelas} ${kelas.nama_kelas}` : '-',
                        bulan: this.filter.bulan
                    };

                    this.showPreview = true;
                },

                printPDF() {
                    window.print();
                },

                exportExcel() {
                    const data = this.nilaiList.map((r, i) => ({
                        "No": i + 1,
                        "Nama": r.nama_siswa,
                        "Formatif (X)": r.formatif,
                        "Mg 1": r.m1,
                        "Mg 2": r.m2,
                        "Mg 3": r.m3,
                        "Mg 4": r.m4,
                        "Rata Tugas (Y)": this.hitungRataMingguan(r),
                        "Nilai Akhir": this.hitungNilaiAkhir(r)
                    }));

                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Laporan");
                    XLSX.writeFile(wb, `Laporan_${this.filter.kelas_id}_${this.filter.bulan}.xlsx`);
                },

                // ===================================
                // STORAGE
                // ===================================
                saveToStorage() {
                    localStorage.setItem('sekolah_db_integrated', JSON.stringify(this.db));
                    localStorage.setItem('sekolah_config', JSON.stringify(this.config));
                },

                loadFromStorage() {
                    const dbData = localStorage.getItem('sekolah_db_integrated');
                    const configData = localStorage.getItem('sekolah_config');

                    if (dbData) {
                        try {
                            this.db = JSON.parse(dbData);
                        } catch (e) {
                            console.error('Error parsing database:', e);
                        }
                    }

                    if (configData) {
                        try {
                            this.config = JSON.parse(configData);
                        } catch (e) {
                            console.error('Error parsing config:', e);
                        }
                    }
                }
            }
        }
    </script>
</body>


</html>
